version: '3.8'

services:
  # ================================================
  # API GATEWAY
  # ================================================
  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: intraday-api-gateway
    ports:
      - "${API_GATEWAY_PORT:-8080}:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-development}
      - MONGODB_URI=${MONGODB_URI}
      - MARKET_DATA_SERVICE_URL=http://market-data-service:8081
      - OPTION_CHAIN_SERVICE_URL=http://option-chain-service:8082
      - RISK_SERVICE_URL=http://risk-service:8083
      - JOURNAL_SERVICE_URL=http://journal-service:8084
      - QUANT_ENGINE_URL=http://quant-engine:8001
      - AI_REASONING_SERVICE_URL=http://ai-reasoning-service:8002
    depends_on:
      - market-data-service
      - option-chain-service
      - risk-service
      - journal-service
      - quant-engine
      - ai-reasoning-service
    restart: unless-stopped
    networks:
      - intraday-network

  # ================================================
  # MARKET DATA SERVICE (Spring Boot)
  # ================================================
  market-data-service:
    build:
      context: ./services/market-data-service
      dockerfile: Dockerfile
    container_name: intraday-market-data
    ports:
      - "${MARKET_DATA_SERVICE_PORT:-8081}:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-development}
      - MONGODB_URI=${MONGODB_URI}
      - FYERS_APP_ID=${FYERS_APP_ID}
      - FYERS_ACCESS_TOKEN=${FYERS_ACCESS_TOKEN}
      - MARKET_START_TIME=${MARKET_START_TIME:-09:15}
      - MARKET_END_TIME=${MARKET_END_TIME:-15:30}
      - QUANT_ENGINE_URL=http://quant-engine:8001
    restart: unless-stopped
    networks:
      - intraday-network

  # ================================================
  # OPTION CHAIN SERVICE (Spring Boot)
  # ================================================
  option-chain-service:
    build:
      context: ./services/option-chain-service
      dockerfile: Dockerfile
    container_name: intraday-option-chain
    ports:
      - "${OPTION_CHAIN_SERVICE_PORT:-8082}:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-development}
      - MONGODB_URI=${MONGODB_URI}
      - FYERS_APP_ID=${FYERS_APP_ID}
      - FYERS_ACCESS_TOKEN=${FYERS_ACCESS_TOKEN}
      - NIFTY_LOT_SIZE=${NIFTY_LOT_SIZE:-50}
      - BANKNIFTY_LOT_SIZE=${BANKNIFTY_LOT_SIZE:-15}
    restart: unless-stopped
    networks:
      - intraday-network

  # ================================================
  # RISK SERVICE (Spring Boot)
  # ================================================
  risk-service:
    build:
      context: ./services/risk-service
      dockerfile: Dockerfile
    container_name: intraday-risk
    ports:
      - "${RISK_SERVICE_PORT:-8083}:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-development}
      - MONGODB_URI=${MONGODB_URI}
      - NIFTY_LOT_SIZE=${NIFTY_LOT_SIZE:-50}
      - BANKNIFTY_LOT_SIZE=${BANKNIFTY_LOT_SIZE:-15}
      - ANGEL_ONE_BROKERAGE=${ANGEL_ONE_BROKERAGE_PER_ORDER:-20}
      - FYERS_BROKERAGE=${FYERS_BROKERAGE_PER_ORDER:-20}
    restart: unless-stopped
    networks:
      - intraday-network

  # ================================================
  # JOURNAL SERVICE (Spring Boot)
  # ================================================
  journal-service:
    build:
      context: ./services/journal-service
      dockerfile: Dockerfile
    container_name: intraday-journal
    ports:
      - "${JOURNAL_SERVICE_PORT:-8084}:8084"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-development}
      - MONGODB_URI=${MONGODB_URI}
    restart: unless-stopped
    networks:
      - intraday-network

  # ================================================
  # QUANT ENGINE (Python FastAPI)
  # ================================================
  quant-engine:
    build:
      context: ./services/quant-engine
      dockerfile: Dockerfile
    container_name: intraday-quant-engine
    ports:
      - "${QUANT_ENGINE_PORT:-8001}:8001"
    environment:
      - MONGODB_URI=${MONGODB_URI}
      - EVALUATION_INTERVAL_MINUTES=${EVALUATION_INTERVAL_MINUTES:-3}
      - CONSERVATIVE_SETUP_THRESHOLD=${CONSERVATIVE_SETUP_THRESHOLD:-8.0}
      - BALANCED_SETUP_THRESHOLD=${BALANCED_SETUP_THRESHOLD:-7.0}
      - AGGRESSIVE_SETUP_THRESHOLD=${AGGRESSIVE_SETUP_THRESHOLD:-6.0}
      - AI_REASONING_SERVICE_URL=http://ai-reasoning-service:8002
    restart: unless-stopped
    networks:
      - intraday-network

  # ================================================
  # AI REASONING SERVICE (Python FastAPI)
  # ================================================
  ai-reasoning-service:
    build:
      context: ./services/ai-reasoning-service
      dockerfile: Dockerfile
    container_name: intraday-ai-reasoning
    ports:
      - "${AI_REASONING_SERVICE_PORT:-8002}:8002"
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GROQ_MODEL=${GROQ_MODEL:-llama-3.1-70b-versatile}
      - MONGODB_URI=${MONGODB_URI}
    restart: unless-stopped
    networks:
      - intraday-network

  # ================================================
  # FRONTEND (Next.js)
  # ================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: intraday-frontend
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:${API_GATEWAY_PORT:-8080}
      - NEXT_PUBLIC_WS_URL=ws://localhost:${API_GATEWAY_PORT:-8080}
      - NEXT_PUBLIC_DEFAULT_RISK_MODE=${NEXT_PUBLIC_DEFAULT_RISK_MODE:-BALANCED}
    depends_on:
      - api-gateway
    restart: unless-stopped
    networks:
      - intraday-network

networks:
  intraday-network:
    driver: bridge
